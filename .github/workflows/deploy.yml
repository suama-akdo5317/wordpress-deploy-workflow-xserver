name: Deploy to Xserver

on:
  push:
    branches:
      - main
      - staging
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p 10022 -H ${{ secrets.REMOTE_HOST }} >> ~/.ssh/known_hosts

      - name: Determine deploy target
        id: target
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "base_path=${{ secrets.REMOTE_TARGET_PROD }}/wp-content" >> $GITHUB_OUTPUT
          else
            echo "base_path=${{ secrets.REMOTE_TARGET_STAGING }}/wp-content" >> $GITHUB_OUTPUT
          fi

      - name: Deploy plugins
        run: |
          rsync -avz --delete \
            -e "ssh -p 10022" \
            ./wordpress/wp-content/plugins/ \
            ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }}:${{ steps.target.outputs.base_path }}/plugins/

      - name: Deploy themes
        run: |
          rsync -avz --delete \
            -e "ssh -p 10022" \
            --exclude 'twenty*/' \
            ./wordpress/wp-content/themes/ \
            ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }}:${{ steps.target.outputs.base_path }}/themes/

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/id_rsa
